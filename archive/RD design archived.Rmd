---
title: "RD design analysis"
author: "Xuyuan Zhang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
geometry: "left=1.5cm,right=1.5cm,top=1cm,bottom=1.5cm"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy=TRUE)
knitr::opts_chunk$set(fig.height=4)
knitr::opts_chunk$set(fig.width=7)
knitr::opts_chunk$set(warning=FALSE)
options(encoding = "UTF-8")
set.seed(123)
```

## structure

1. we first report the figure and export the figure to the folder named figures in directory
2. we then report the main result of the regressions
3. lastly, we report the placebo test and the robustness check

```{r}
# these are the packages that we need to import
library(haven)
library(ggplot2)
library(dplyr)
library(rdrobust)
library(plm)
library(pander) # this is for table showing
library(latex2exp) # this is to export it
setwd("E:/umich/RealEstateBrokerage-main")
# need to place data on the base directory
data <- read_dta("template.dta")
```

```{r}
panel_data <- pdata.frame(data, index = c("id", "year"))
panel_data$L_jiadian <- lag(panel_data$jiadian, 1)
panel_data$L_kind <- lag(panel_data$kind, 1)
panel_data$L_hotel <- lag(panel_data$hotel, 1)
panel_data$L_shop_mall <- lag(panel_data$shop_mall, 1)
panel_data$L_museum <- lag(panel_data$museum, 1)
panel_data$L_old <- lag(panel_data$old, 1)
panel_data$L_ktv <- lag(panel_data$ktv, 1)
panel_data$L_mid <- lag(panel_data$mid, 1)
panel_data$L_prim <- lag(panel_data$prim, 1)
panel_data$L_west_food <- lag(panel_data$west_food, 1)
panel_data$L_super <- lag(panel_data$super, 1)
panel_data$L_sub <- lag(panel_data$sub, 1)
panel_data$L_park <- lag(panel_data$park, 1)
```

we use these control variables

```{r}
control_variables <- c(
  "jiadian", "kind", "hotel", "shop_mall", "museum", "old", "ktv", "mid", "prim", "west_food", "super", "sub", "park", 
  "area", "bedroom", "toilet", "house_age", "floor_level", "green_ratio", "total_building", "total_floor_number", "living_room", "elevator_ratio", "kitchen", "floor_ratio", "total_resident",
  "pm25", "pop", "light",
  "non_online_effect", "ln_negotiation_period", "ln_watch_time", "ln_nego_changes", "ln_lead", "ln_watch_people"
)
testing_variables <- c("ln_negotiation_period", "ln_watch_time", "ln_nego_changes", "ln_lead", "ln_watch_people", "ln_end_price")
```

```{r}
result <- rdrobust(y = panel_data$ln_income, x = panel_data$nearest_store_distances, 
                   c = 0.41, covs = panel_data[, control_variables],
                   p = 1) # first using default clustering
```

```{r}
h = 0.066
cutoff = 0.41
running_var = panel_data$nearest_store_distances

filtered_data <- panel_data[abs(running_var - cutoff) <= h, ]

# Export the first RD plot to its own PDF file
pdf("RD_Plot_1st_Order.pdf", width = 8, height = 4) # Adjust the width and height as needed
rdplot(y = filtered_data$ln_income, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 1,
       title = "RD-plot 1st order polynomial",
       x.label = "Nearest distance to Lianjia's stores",
       y.label = "Log of income in the community")
dev.off() # Close the PDF device

# Export the second RD plot to its own PDF file
pdf("RD_Plot_2nd_Order.pdf", width = 8, height = 4) # Adjust the width and height as needed
rdplot(y = filtered_data$ln_income, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 2,
       title = "RD-plot 2nd order polynomial",
       x.label = "Nearest distance to Lianjia's stores",
       y.label = "Log of income in the community")
dev.off() # Close the PDF device

# Export the third RD plot to its own PDF file
pdf("RD_Plot_3rd_Order.pdf", width = 8, height = 4) # Adjust the width and height as needed
rdplot(y = filtered_data$ln_income, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 3,
       title = "RD-plot 3rd order polynomial",
       x.label = "Nearest distance to Lianjia's stores",
       y.label = "Log of income in the community")
dev.off() # Close the PDF device

```


```{r}
result
```


```{r}
pander(cbind(result$coef, result$pv))
```

```{r}
result <- rdrobust(y = panel_data$pop, x = panel_data$nearest_store_distances, 
                   c = 0.41,
                   p = 1) # first using default clustering
result2 <- rdrobust(y = panel_data$light, x = panel_data$nearest_store_distances, 
                   c = 0.41,
                   p = 1)
result3 <- rdrobust(y = panel_data$ln_end_price, x = panel_data$nearest_store_distances, 
                   c = 0.41,
                   p = 1)
```



```{r}
pander(cbind(result$coef, result$pv))
pander(cbind(result2$coef, result2$pv))
pander(cbind(result3$coef, result3$pv))
```

note that the figure only shows points that are within the bandwidth, the whole points are shown in Appendix of the paper.


```{r}
h = 0.124
cutoff = 0.41
running_var = panel_data$nearest_store_distances

filtered_data <- panel_data[abs(running_var - cutoff) <= h, ]

par(mfrow=c(3,1))
rdplot(y = filtered_data$ln_lead, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 1,
       title = "RD-plot",
       x.label = "nearest distance to lianjia's stores",
       y.label = "lianjia's income in the community")

rdplot(y = filtered_data$ln_lead, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 2,
       title = "RD-plot",
       x.label = "nearest distance to lianjia's stores",
       y.label = "lianjia's income in the community")

rdplot(y = filtered_data$ln_lead, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 3,
       title = "RD-plot",
       x.label = "nearest distance to lianjia's stores",
       y.label = "lianjia's income in the community")
```

```{r}
h = 0.158
cutoff = 0.41
running_var = panel_data$nearest_store_distances

filtered_data <- panel_data[abs(running_var - cutoff) <= h, ]

par(mfrow=c(3,1))
rdplot(y = filtered_data$price_concession, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 1,
       title = "RD-plot",
       x.label = "nearest distance to lianjia's stores",
       y.label = "lianjia's income in the community")

rdplot(y = filtered_data$price_concession, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 2,
       title = "RD-plot",
       x.label = "nearest distance to lianjia's stores",
       y.label = "lianjia's income in the community")

rdplot(y = filtered_data$price_concession, 
       x = filtered_data$nearest_store_distances, 
       c = cutoff, nbins = 40, p = 3,
       title = "RD-plot",
       x.label = "nearest distance to lianjia's stores",
       y.label = "lianjia's income in the community")
```

checkings:

1. Donut Hole: Exclude observations close to the cutoff and estimate the effect with the remaining data. If the discontinuity persists despite the absence of data around the cutoff, this provides evidence against a model misspecification.
2. Mccrary (2008) test: Conduct a McCrary density test to check if there is a discontinuity in the density of the running variable at the cutoff. A significant discontinuity may suggest manipulation or sorting around the cutoff.
3. Placebo test: If you have pre-treatment covariates, you can test whether these covariates also jump at the cutoff. If they do, this might suggest manipulation or a violation of the RD design assumptions. If they don’t, it strengthens the case for a true treatment effect.

```{r}
cutoff
donut_width <- 0.011
panel_data_donut <- panel_data[!(panel_data$nearest_store_distances >= (cutoff - donut_width) & 
                                 panel_data$nearest_store_distances <= (cutoff + donut_width)),]
result_donut <- rdrobust(y = panel_data_donut$ln_income, 
                         x = panel_data_donut$nearest_store_distances, 
                         c = cutoff,
                        p = 1, h = 0.066, b = 0.135)
pander(cbind(result_donut$coef, result_donut$pv))
print(result_donut)
```


```{r}
donut_width <- 0.015
panel_data_donut <- panel_data[!(panel_data$nearest_store_distances >= (cutoff - donut_width) & 
                                 panel_data$nearest_store_distances <= (cutoff + donut_width)),]
result_donut <- rdrobust(y = panel_data_donut$ln_income, 
                         x = panel_data_donut$nearest_store_distances, 
                         c = cutoff,  covs = panel_data_donut[, control_variables],
                        p = 1, h = 0.095, b = 0.185)
pander(cbind(result_donut$coef, result_donut$pv))
print(result_donut)
```

```{r}

library(rdd)

# Give it the running variable and the cutpoint
# it will automatically produce a plot and select the number of bins and the bandwidth
# The output will be the p-value for the presence of a discontinuity
DCdensity(panel_data$nearest_store_distances, cutpoint = 0.41, bw = 0.066, verbose = TRUE, plot = FALSE)
```


```{r}
library(rdd)

# Give it the running variable and the cutpoint
# it will automatically produce a plot and select the number of bins and the bandwidth
# The output will be the p-value for the presence of a discontinuity
DCdensity(panel_data$nearest_store_distances, cutpoint = 0.41, bw = 0.095, verbose = TRUE, plot = FALSE)
```

Conducting placebo test. We shall using the same validation bandwidth and bias correction bandwidth. The results are good overall

```{r}
for (validation in testing_variables) {
  rd_result <- rdrobust(y = panel_data[[validation]], x = panel_data$nearest_store_distances
                        , c = 0.41, h = 0.066, b = 0.135)
  cat("Covariate:", validation, "\n")
  print(summary(rd_result))
  cat("\n\n")
   
}
```



```{r}
results <- data.frame(
  Cutpoint = numeric(),
  Bandwidth = numeric(),
  LogDiff = numeric(),
  SE = numeric(),
  ZStat = numeric(),
  PValue = numeric()
)

h = 0.066
cutoff = 0.41
running_var = panel_data$nearest_store_distances

filtered_data <- panel_data[abs(running_var - cutoff) <= h, ]

# 定义切点和带宽的向量
cutpoints <- c(0.41)
bandwidths <- c(0.60, 0.063, 0.066, 0.069, 0.72)

results_list <- list()

# 循环遍历切点和带宽
counter <- 1
for (cutpoint in cutpoints) {
  for (bw in bandwidths) {
    # 运行 McCrary Sorting Test 并捕获输出
    capture_output <- capture.output(result <- DCdensity(filtered_data$nearest_store_distances, cutpoint = cutpoint, bw = bw, verbose = TRUE, plot = FALSE))
    
    # 提取结果
    log_diff <- as.numeric(sub(".*Log difference in heights is\\s+([-+]?\\d*\\.\\d+).*", "\\1", capture_output[grep("Log difference in heights is", capture_output)]))
    se <- as.numeric(sub(".*with SE\\s+([-+]?\\d*\\.\\d+).*", "\\1", capture_output[grep("with SE", capture_output)]))
    z_stat <- as.numeric(sub(".*this gives a z-stat of\\s+([-+]?\\d*\\.\\d+).*", "\\1", capture_output[grep("this gives a z-stat of", capture_output)]))
    p_value <- as.numeric(sub(".*and a p value of\\s+([-+]?\\d*\\.\\d+).*", "\\1", capture_output[grep("and a p value of", capture_output)]))
    
    # 将结果存储到列表中
    results_list[[counter]] <- data.frame(
      Cutpoint = cutpoint,
      Bandwidth = bw,
      LogDiff = log_diff,
      SE = se,
      ZStat = z_stat,
      PValue = p_value
    )
    counter <- counter + 1
  }
}

# 将结果列表转换为数据框
results <- do.call(rbind, results_list)

# 打印结果数据框
print(results)
```

